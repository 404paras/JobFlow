name: Keep Backend Alive

on:
  schedule:
    # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    # â”‚ IST (UTC+5:30) â†’ UTC Conversion:                                        â”‚
    # â”‚   9:00 AM IST  = 03:30 UTC  â†’  wake at 03:20 UTC (10 min before)        â”‚
    # â”‚   6:00 PM IST  = 12:30 UTC  â†’  wake at 12:20 UTC (10 min before)        â”‚
    # â”‚   Monday 9 AM IST = Monday 03:30 UTC                                    â”‚
    # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    - cron: '20 3 * * *'    # Daily 03:20 UTC = 08:50 IST (before 9 AM job)
    - cron: '20 12 * * *'   # Daily 12:20 UTC = 17:50 IST (before 6 PM job)
    - cron: '20 3 * * 1'    # Monday 03:20 UTC = Monday 08:50 IST (weekly job)
  
  # Manual trigger for testing
  workflow_dispatch:

env:
  # Configurable health endpoint (default: /health)
  HEALTH_PATH: ${{ secrets.HEALTH_PATH || '/health' }}

jobs:
  wake-backend:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Validate Configuration
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â° UTC Time: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "ðŸ“ Health Path: ${{ env.HEALTH_PATH }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -z "${{ secrets.BACKEND_URL }}" ]; then
            echo "âŒ ERROR: BACKEND_URL secret is not configured!"
            echo ""
            echo "To fix this:"
            echo "1. Go to your GitHub repo â†’ Settings â†’ Secrets â†’ Actions"
            echo "2. Add secret: BACKEND_URL = https://your-app.onrender.com"
            exit 1
          fi
          
          echo "âœ… Configuration valid"

      - name: Wake Up Backend
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL }}
        run: |
          ENDPOINT="${BACKEND_URL}${{ env.HEALTH_PATH }}"
          MAX_ATTEMPTS=3
          ATTEMPT=0
          SUCCESS=false
          
          echo "ðŸŽ¯ Target: $ENDPOINT"
          echo ""
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            
            # Exponential backoff: 0s, 30s, 60s wait before each attempt
            if [ $ATTEMPT -gt 1 ]; then
              WAIT_TIME=$((30 * (ATTEMPT - 1)))
              echo "â³ Waiting ${WAIT_TIME}s before retry..."
              sleep $WAIT_TIME
            fi
            
            echo "ðŸ“ Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            # Curl with timeout and retry logic
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              --connect-timeout 30 \
              --max-time 120 \
              --retry 2 \
              --retry-delay 5 \
              "$ENDPOINT" 2>/dev/null || echo "000")
            
            echo "   HTTP Status: $HTTP_CODE"
            
            # Accept any 2xx response as success
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              SUCCESS=true
              echo "âœ… Backend is awake! (HTTP $HTTP_CODE)"
              break
            elif [ "$HTTP_CODE" = "000" ]; then
              echo "   âš ï¸  Connection failed or timed out"
            else
              echo "   âš ï¸  Unexpected response"
            fi
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ "$SUCCESS" = true ]; then
            echo "ðŸŽ‰ Wake-up successful!"
          else
            echo "âš ï¸  Backend may still be starting. Scheduled job will retry."
            echo "   (Not failing workflow to keep schedule stable)"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Verify API Health
        if: success()
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL }}
        run: |
          echo "ðŸ” Quick API verification..."
          
          API_RESPONSE=$(curl -s --max-time 15 "${BACKEND_URL}/api/health" 2>/dev/null || echo '{"status":"timeout"}')
          
          echo "Response: $API_RESPONSE"
          echo ""
          echo "âœ… Keep-alive workflow complete!"
