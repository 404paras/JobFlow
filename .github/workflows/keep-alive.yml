name: Keep Backend Alive

on:
  schedule:
    # Wake up 10 minutes before scheduled job times (IST ‚Üí UTC conversion)
    # IST is UTC+5:30, so:
    # - 9 AM IST = 3:30 AM UTC ‚Üí wake at 3:20 AM UTC
    # - 6 PM IST = 12:30 PM UTC ‚Üí wake at 12:20 PM UTC
    
    - cron: '20 3 * * *'    # 3:20 AM UTC (8:50 AM IST) - before 9 AM IST job
    - cron: '20 12 * * *'   # 12:20 PM UTC (5:50 PM IST) - before 6 PM IST job
    - cron: '20 3 * * 1'    # Monday 3:20 AM UTC - before weekly 9 AM IST job
  
  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  wake-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Wake Up Backend
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL }}
        run: |
          echo "‚è∞ Waking up backend before scheduled job..."
          echo "üïê Current UTC time: $(date -u)"
          echo "üîó Backend URL: ${BACKEND_URL:-NOT_SET}"
          
          if [ -z "$BACKEND_URL" ]; then
            echo "‚ùå BACKEND_URL secret is not set!"
            echo "Please add BACKEND_URL secret in GitHub repo settings"
            exit 1
          fi
          
          # First ping - might take longer due to cold start (up to 2 minutes for Render)
          echo "üèì Sending wake-up ping..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 120 "${BACKEND_URL}/health" || echo "000")
          echo "üì° Response: HTTP $RESPONSE"
          
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Backend is awake!"
          else
            echo "‚è≥ Cold start detected, waiting 45s and retrying..."
            sleep 45
            
            # Retry ping
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 120 "${BACKEND_URL}/health" || echo "000")
            echo "üì° Retry response: HTTP $RESPONSE"
            
            if [ "$RESPONSE" = "200" ]; then
              echo "‚úÖ Backend is now awake!"
            else
              echo "‚ö†Ô∏è Backend not responding (HTTP $RESPONSE), but continuing..."
              # Don't exit 1 - the scheduled job might still wake it up
            fi
          fi

      - name: Verify API is Ready
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL }}
        run: |
          echo "üîç Verifying API health..."
          curl -s --max-time 30 "${BACKEND_URL}/api/health" || echo "API health check timed out"
          echo ""
          echo "‚úÖ Wake-up attempt complete!"
